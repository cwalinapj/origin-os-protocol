name: Rust

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  CARGO_TERM_COLOR: always
  SOLANA_VERSION: "1.18.26"
  ANCHOR_VERSION: "0.30.1"

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    # Install Rust (handled by rust-toolchain.toml)
    - name: Setup Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: "1.79.0"

    # Install Node.js and Yarn for Anchor tests
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install Yarn
      run: npm install -g yarn

    - name: Install Node dependencies
      run: yarn install

    # Install Solana CLI
    - name: Cache Solana
      id: cache-solana
      uses: actions/cache@v4
      with:
        path: ~/.local/share/solana/install
        key: solana-${{ env.SOLANA_VERSION }}

    - name: Install Solana
      if: steps.cache-solana.outputs.cache-hit != 'true'
      run: |
        sh -c "$(curl -sSfL https://release.anza.xyz/v${{ env.SOLANA_VERSION }}/install)"

    - name: Add Solana to PATH
      run: echo "$HOME/.local/share/solana/install/active_release/bin" >> $GITHUB_PATH

    # Install Anchor CLI
    - name: Cache Anchor
      id: cache-anchor
      uses: actions/cache@v4
      with:
        path: ~/.cargo/bin/anchor
        key: anchor-${{ env.ANCHOR_VERSION }}

    - name: Install Anchor CLI
      if: steps.cache-anchor.outputs.cache-hit != 'true'
      run: |
        cargo install --git https://github.com/coral-xyz/anchor avm --locked --force
        avm install ${{ env.ANCHOR_VERSION }}
        avm use ${{ env.ANCHOR_VERSION }}

    # Build and test
    - name: Build with Cargo
      run: cargo build --verbose

    - name: Run Rust unit tests
      run: cargo test --verbose

    - name: Build with Anchor
      run: anchor build

    - name: Run Anchor tests
      run: anchor test
